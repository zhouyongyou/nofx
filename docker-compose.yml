# âš ï¸ é‡è¦æç¤ºï¼šè¯·å®šæœŸå¤‡ä»½ä»¥ä¸‹æ ¸å¿ƒèµ„äº§ç›®å½•/æ–‡ä»¶
# 1. config.db (+ config.db-wal/shm) - ç³»ç»Ÿé…ç½®æ•°æ®åº“
# 2. prompts/ - AI æç¤ºè¯æ¨¡æ¿
# 3. decision_logs/ - å®Œæ•´å†³ç­–å†å²
# 4. secrets/ - RSA å¯†é’¥æ–‡ä»¶

services:
  # Backend service (API and core logic)
  nofx:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.backend
    container_name: nofx-trading
    restart: unless-stopped
    stop_grace_period: 30s  # å…è®¸åº”ç”¨æœ‰ 30 ç§’æ—¶é—´ä¼˜é›…å…³é—­
    ports:
      - "${NOFX_BACKEND_PORT:-8080}:8080"
    volumes:
      - ./config.json:/app/config.json:ro  # åŸºç¡€é…ç½®æ–‡ä»¶ï¼ˆæ æ†ã€é£æ§å‚æ•°ç­‰ï¼Œåªè¯»ï¼‰
      - ./config.db:/app/config.db  # ğŸ”¥ æ ¸å¿ƒèµ„äº§ï¼šç³»ç»Ÿé…ç½®æ•°æ®åº“ï¼ˆäº¤æ˜“å‘˜é…ç½®ã€APIå¯†é’¥ã€ç”¨æˆ·æ•°æ®ç­‰ï¼‰
      - ./config.db-wal:/app/config.db-wal  # SQLite WAL æ–‡ä»¶ï¼ˆWrite-Ahead Logï¼Œå¿…é¡»æ˜ å°„ä»¥æ”¯æŒ WAL æ¨¡å¼ï¼‰
      - ./config.db-shm:/app/config.db-shm  # SQLite SHM æ–‡ä»¶ï¼ˆShared Memoryï¼Œå¿…é¡»æ˜ å°„ä»¥æ”¯æŒ WAL æ¨¡å¼ï¼‰
      - ./beta_codes.txt:/app/beta_codes.txt:ro  # å†…æµ‹é‚€è¯·ç æ–‡ä»¶ï¼ˆåªè¯»ï¼‰
      - ./prompts:/app/prompts  # ğŸ”¥ æ ¸å¿ƒèµ„äº§ï¼šAI æç¤ºè¯æ¨¡æ¿ç›®å½•ï¼ˆå†³å®šäº¤æ˜“ç­–ç•¥å’Œå†³ç­–è´¨é‡ï¼‰
      - ./secrets:/app/secrets:ro  # RSA å¯†é’¥æ–‡ä»¶ç›®å½•ï¼ˆç”¨äºåŠ å¯†æ•æ„Ÿæ•°æ®ï¼Œåªè¯»ï¼‰
      - ./decision_logs:/app/decision_logs  # ğŸ”¥ æ ¸å¿ƒèµ„äº§ï¼šå®Œæ•´å†³ç­–å†å²ç›®å½•ï¼ˆAIæ€ç»´é“¾ã€äº¤æ˜“è®°å½•ã€æ€§èƒ½åˆ†ææ•°æ®ï¼‰
      - /etc/localtime:/etc/localtime:ro  # åŒæ­¥å®¿ä¸»æœºæ—¶åŒº
    environment:
      - TZ=${NOFX_TIMEZONE:-Asia/Shanghai}  # Set timezone
      - AI_MAX_TOKENS=4000  # AIå“åº”çš„æœ€å¤§tokenæ•°ï¼ˆé»˜è®¤2000ï¼Œå»ºè®®4000-8000ï¼‰
      - DATA_ENCRYPTION_KEY=${DATA_ENCRYPTION_KEY}  # æ•°æ®åº“åŠ å¯†å¯†é’¥
      - JWT_SECRET=${JWT_SECRET}  # JWTè®¤è¯å¯†é’¥
      - ENVIRONMENT=${ENVIRONMENT:-production}  # ç¯å¢ƒç±»å‹ (development/production)
    networks:
      - nofx-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Frontend service (static serving and proxy)
  nofx-frontend:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.frontend
    container_name: nofx-frontend
    restart: unless-stopped
    ports:
      - "${NOFX_FRONTEND_PORT:-3000}:80"
    networks:
      - nofx-network
    depends_on:
      - nofx
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

networks:
  nofx-network:
    driver: bridge